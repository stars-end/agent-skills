#!/usr/bin/env bash
set -euo pipefail

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip if it's a merge commit or automated squash/fixup.
if echo "$COMMIT_MSG" | grep -q "^Merge "; then
  exit 0
fi
if echo "$COMMIT_MSG" | grep -q "^squash!" || echo "$COMMIT_MSG" | grep -q "^fixup!"; then
  exit 0
fi

# Skip if it's an auto-checkpoint commit.
if echo "$COMMIT_MSG" | grep -q "^checkpoint:"; then
  exit 0
fi

# Enforce Feature-Key
if ! echo "$COMMIT_MSG" | grep -q "Feature-Key:"; then
  cat >&2 <<EOF

❌ COMMIT BLOCKED: Missing Feature-Key

Every commit must include a Feature-Key trailer for traceability.
  Example:
    feat: your summary

    Feature-Key: bd-f6fh
    Agent: codex

EOF
  exit 1
fi

FEATURE_KEY_VALUE="$(echo "$COMMIT_MSG" | awk -F': ' '/^Feature-Key: /{print $2; exit}')"
if [[ -z "${FEATURE_KEY_VALUE:-}" ]]; then
  cat >&2 <<EOF

❌ COMMIT BLOCKED: Invalid Feature-Key trailer

Feature-Key trailer is present but empty.
Expected format:
  Feature-Key: bd-xxxx
  Feature-Key: bd-xxxx.1

EOF
  exit 1
fi

# Accept dotted child IDs (e.g., bd-5wys.10).
if [[ ! "$FEATURE_KEY_VALUE" =~ ^bd-[a-z0-9]+(\.[a-z0-9]+)*$ ]]; then
  cat >&2 <<EOF

❌ COMMIT BLOCKED: Invalid Feature-Key format

Feature-Key must match:
  ^bd-[a-z0-9]+(\\.[a-z0-9]+)*$

Examples:
  Feature-Key: bd-5wys
  Feature-Key: bd-5wys.10

EOF
  exit 1
fi

# Enforce Agent
if ! echo "$COMMIT_MSG" | grep -q "Agent:"; then
  cat >&2 <<EOF

❌ COMMIT BLOCKED: Missing Agent trailer

Every commit must include an Agent trailer for attribution.
  Example:
    feat: your summary

    Feature-Key: bd-f6fh
    Agent: codex

EOF
  exit 1
fi

exit 0
