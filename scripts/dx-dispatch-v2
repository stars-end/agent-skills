#!/bin/bash
# dx-dispatch - Compat shim forwarding to dx-runner
#
# DEPRECATED: This script is a compatibility layer for the legacy dx-dispatch
# interface. New code should use dx-runner directly.
#
# Migration guide:
#   dx-dispatch epyc12 "task"           -> dx-runner start --provider opencode --beads <id> --prompt-file <path>
#   dx-dispatch --list                  -> dx-runner status
#   dx-dispatch --status epyc12         -> dx-runner check --beads <id>
#   dx-dispatch --session <id> "cont"   -> dx-runner start --beads <id> --provider <from-meta>
#
# This shim translates legacy commands to dx-runner calls.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DX_RUNNER="${SCRIPT_DIR}/dx-runner"

deprecation_warn() {
    echo "[DEPRECATED] dx-dispatch is deprecated. Use dx-runner instead." >&2
    echo "[DEPRECATED] See: ~/agent-skills/docs/adr/ADR-DX-RUNNER.md" >&2
}

# Check if dx-runner exists
if [[ ! -x "$DX_RUNNER" ]]; then
    echo "ERROR: dx-runner not found at $DX_RUNNER" >&2
    echo "ERROR: This compat shim requires dx-runner to be installed." >&2
    exit 1
fi

# Parse args to determine translation
case "${1:-}" in
    --list)
        deprecation_warn
        shift
        exec "$DX_RUNNER" status "$@"
        ;;
    --status)
        deprecation_warn
        shift
        # --status <vm> becomes status command
        exec "$DX_RUNNER" status "$@"
        ;;
    --help|-h)
        deprecation_warn
        echo ""
        echo "Legacy dx-dispatch interface (forwards to dx-runner)"
        echo ""
        echo "Usage:"
        echo "  dx-dispatch <vm> <task> [options]   Dispatch task to VM"
        echo "  dx-dispatch --list                  List VMs (status)"
        echo "  dx-dispatch --status <vm>           Check VM status"
        echo ""
        echo "Options are translated to dx-runner equivalents where possible."
        echo ""
        exec "$DX_RUNNER" --help
        ;;
    --session)
        deprecation_warn
        shift
        local session_id="${1:-}"
        shift 2 || true
        local task="${1:-Continue}"
        
        # Look up session in state store
        local state_file="$HOME/.cache/dx-dispatch/fleet-state.json"
        if [[ -f "$state_file" ]]; then
            local provider
            provider="$(jq -r ".[] | select(.session_id == \"$session_id\") | .backend_name // \"cc-glm\"" "$state_file" 2>/dev/null)" || provider="cc-glm"
            
            # Create temp prompt file
            local prompt_file="/tmp/dx-dispatch-resume-$session_id.prompt"
            echo "$task" > "$prompt_file"
            
            exec "$DX_RUNNER" start \
                --provider "$provider" \
                --beads "resume-$session_id" \
                --prompt-file "$prompt_file"
        else
            echo "ERROR: Session $session_id not found in state store" >&2
            exit 1
        fi
        ;;
    -*)
        # Unknown flag
        deprecation_warn
        echo "ERROR: Unknown flag: $1" >&2
        exec "$DX_RUNNER" --help
        ;;
    *)
        # Positional: <vm> <task>
        deprecation_warn
        
        if [[ -z "${1:-}" || -z "${2:-}" ]]; then
            echo "ERROR: dx-dispatch requires <vm> and <task> arguments" >&2
            echo "Usage: dx-dispatch <vm> <task>" >&2
            exit 2
        fi
        
        local vm="$1"
        shift
        local task="$1"
        shift
        
        # Map VM to provider
        local provider="opencode"
        case "$vm" in
            cc-glm|local)
                provider="cc-glm"
                ;;
            opencode)
                provider="opencode"
                ;;
            gemini)
                provider="gemini"
                ;;
            *)
                # Assume OpenCode for VM targets
                provider="opencode"
                ;;
        esac
        
        # Parse remaining options for Beads ID
        local beads_id=""
        local repo=""
        local worktree=""
        
        while [[ $# -gt 0 ]]; do
            case "$1" in
                --beads)
                    beads_id="$2"
                    shift 2
                    ;;
                --repo)
                    repo="$2"
                    shift 2
                    ;;
                --worktree)
                    worktree="$2"
                    shift 2
                    ;;
                *)
                    shift
                    ;;
            esac
        done
        
        # Generate Beads ID if not provided
        if [[ -z "$beads_id" ]]; then
            beads_id="dispatch-$(date +%Y%m%d%H%M%S)"
        fi
        
        # Create temp prompt file
        local prompt_file="/tmp/dx-dispatch-${beads_id}.prompt"
        echo "$task" > "$prompt_file"
        
        echo "[dx-dispatch -> dx-runner] provider=$provider beads=$beads_id"
        
        # Build dx-runner command
        local cmd_args=(
            "$DX_RUNNER" start
            --provider "$provider"
            --beads "$beads_id"
            --prompt-file "$prompt_file"
        )
        
        [[ -n "$repo" ]] && cmd_args+=(--repo "$repo")
        [[ -n "$worktree" ]] && cmd_args+=(--worktree "$worktree")
        
        exec "${cmd_args[@]}"
        ;;
esac
