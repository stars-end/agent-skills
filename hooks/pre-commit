#!/bin/bash
# Global pre-commit hook for agent-skills
# Chains Beads functionality with any other pre-commit checks
#
# V8 pattern: Respect external BEADS_DIR (~/bd/.beads) over repo-local .beads
# Only auto-detect if BEADS_DIR is not set. Use --no-daemon for determinism.

# shellcheck disable=SC1090
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Check if bd is available
if ! command -v bd >/dev/null 2>&1; then
    exit 0
fi

# V8: Respect existing BEADS_DIR from environment (external ~/bd/.beads)
# Only auto-detect if not already set.
if [ -z "${BEADS_DIR:-}" ]; then
    # Check if we're in a bd workspace with repo-local .beads
    if git rev-parse --git-dir >/dev/null 2>&1; then
        if [ "$(git rev-parse --git-dir)" != "$(git rev-parse --git-common-dir)" ]; then
            MAIN_REPO_ROOT="$(git rev-parse --git-common-dir)"
            MAIN_REPO_ROOT="$(dirname "$MAIN_REPO_ROOT")"
            if [ -d "$MAIN_REPO_ROOT/.beads" ]; then
                export BEADS_DIR="$MAIN_REPO_ROOT/.beads"
            fi
        else
            if [ -d .beads ]; then
                export BEADS_DIR="$(pwd)/.beads"
            fi
        fi
    fi
fi

if [ -z "${BEADS_DIR:-}" ]; then
    exit 0
fi

# Verify BEADS_DIR points to a valid beads workspace (has issues.jsonl)
if [ ! -f "${BEADS_DIR}/issues.jsonl" ]; then
    exit 0
fi

# Flush pending changes to JSONL.
# Default behavior is warn-only to avoid contradictory "commit succeeded + error" UX.
# Set BEADS_FLUSH_STRICT=1 to make this blocking.
# V8: Use --no-daemon for deterministic behavior (avoids daemon staleness issues).
if ! bd --no-daemon sync --flush-only >/dev/null 2>&1; then
    if [[ "${BEADS_FLUSH_STRICT:-0}" == "1" ]]; then
        echo "Error: Failed to flush bd changes to JSONL (strict mode)" >&2
        echo "BEADS_DIR=$BEADS_DIR" >&2
        echo "Run 'bd --no-daemon sync --flush-only' manually to diagnose" >&2
        exit 1
    fi
    echo "Warning: Failed to flush bd changes to JSONL (non-blocking)" >&2
    echo "BEADS_DIR=$BEADS_DIR" >&2
    echo "Run 'bd --no-daemon sync --flush-only' manually to diagnose" >&2
fi

# If the JSONL file was modified, stage it
# Only for regular repos (not worktrees) where JSONL is in working tree.
# For V8 external BEADS_DIR (~/bd/.beads), this path is outside the repo, so skip.
if [ -f "${BEADS_DIR}/issues.jsonl" ]; then
    if [ "$(git rev-parse --git-dir)" = "$(git rev-parse --git-common-dir)" ]; then
        # Only stage if BEADS_DIR is within the repo working tree
        local_jsonl="${BEADS_DIR}/issues.jsonl"
        repo_root="$(git rev-parse --show-toplevel)"
        case "$local_jsonl" in
            "$repo_root"*)
                git add "$local_jsonl" 2>/dev/null || true
                ;;
        esac
    fi
fi

exit 0
