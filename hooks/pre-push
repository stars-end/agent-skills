#!/bin/bash
# dx-triage pre-push hook
# Part of the dx-triage enforcement system
#
# This hook runs before git push and checks:
# 1. Railway deployment status (if applicable)
# 2. dx-triage status flag (repo needs attention)
#
# Pass --no-verify to git push to bypass this hook.

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RESET='\033[0m'

# Get repo name from current directory
REPO_NAME="$(basename "$(git rev-parse --show-toplevel)")"

# ============================================================================
# SECTION 1: Railway environment check
# ============================================================================
# Blocks push if RAILWAY_ENVIRONMENT is set (Railway project detected)
# This prevents pushing during active Railway deployments

check_railway_status() {
    # Check if we're in a Railway environment
    # RAILWAY_ENVIRONMENT is set when railway link/configure has been run
    if [[ -n "${RAILWAY_ENVIRONMENT:-}" ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Railway environment detected${RESET}"
        echo ""
        echo "RAILWAY_ENVIRONMENT is set to: ${RAILWAY_ENVIRONMENT}"
        echo ""
        echo "Pushing while in a Railway project may cause:"
        echo "  - Deployment conflicts"
        echo "  - Inconsistent application state"
        echo ""
        echo "To check active deployments: railway status"
        echo "To bypass: git push --no-verify"
        echo ""
        return 1
    fi

    return 0
}

# ============================================================================
# SECTION 2: dx-triage status check
# ============================================================================

check_triage_status() {
    local STATUS_FILE=".git/DX_TRIAGE_STATUS"
    local REQUIRED_FILE=".git/DX_TRIAGE_REQUIRED"
    local ACK_FILE=".git/DX_TRIAGE_ACK"

    local status_mtime=0
    local ack_mtime=0
    local block_reason=""
    local blocking_file=""

    # Check DX_TRIAGE_REQUIRED (critical - always blocks)
    if [[ -f "$REQUIRED_FILE" ]]; then
        block_reason="CRITICAL: Manual review required"
        blocking_file="$REQUIRED_FILE"
    fi

    # Check DX_TRIAGE_STATUS vs ACK timestamp (forced review)
    if [[ -f "$STATUS_FILE" ]]; then
        status_mtime=$(stat -f %m "$STATUS_FILE" 2>/dev/null || stat -c %Y "$STATUS_FILE" 2>/dev/null || echo "0")
    fi

    if [[ -f "$ACK_FILE" ]]; then
        ack_mtime=$(stat -f %m "$ACK_FILE" 2>/dev/null || stat -c %Y "$ACK_FILE" 2>/dev/null || echo "0")
    fi

    # If status is newer than ACK, review is required
    if [[ "$status_mtime" -gt "$ack_mtime" ]]; then
        if [[ -z "$block_reason" ]]; then
            block_reason="Status updated since last acknowledgment"
            blocking_file="$STATUS_FILE"
        fi
    fi

    # If no block needed, return success
    if [[ -z "$block_reason" ]]; then
        return 0
    fi

    # Display block message
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${RESET}"
    echo -e "${CYAN}‚ïë  ‚ö†Ô∏è  PUSH BLOCKED - $block_reason${RESET}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${RESET}"
    echo ""

    # Show the blocking file content
    cat "$blocking_file"
    echo ""

    # Show ACK timestamp if exists
    if [[ -f "$ACK_FILE" ]]; then
        echo -e "${YELLOW}Last ACK:${RESET} $(date -r "$ACK_FILE" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || stat -c %y "$ACK_FILE" 2>/dev/null | cut -d'.' -f1)"
        echo ""
    fi

    echo -e "${YELLOW}Before pushing, you must:${RESET}"
    echo ""
    echo -e "  ${GREEN}dx-triage${RESET}              # See full status of all repos"
    echo -e "  ${GREEN}dx-triage --fix${RESET}         # Apply safe fixes"
    echo -e "  ${GREEN}dx-triage --ack${RESET}         # Acknowledge status and record review"
    echo ""
    echo -e "Or to bypass: ${CYAN}git push --no-verify${RESET}"
    echo ""

    return 1
}

# ============================================================================
# SECTION 3: ci-lite check (preserved from original hook)
# ============================================================================

check_ci_lite() {
    if [ -f Makefile ] && grep -q "ci-lite:" Makefile; then
        echo -e "${CYAN}üß™ Running make ci-lite...${RESET}"
        if ! make ci-lite; then
            echo -e "${RED}‚ùå PUSH BLOCKED: CI-Lite failed.${RESET}"
            echo -e "${YELLOW}üö® Fix errors before pushing or use --no-verify (not recommended).${RESET}"
            return 1
        fi
    fi
    return 0
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

# Run checks in order
check_railway_status || exit 1
check_triage_status || exit 1
check_ci_lite || exit 1

exit 0
