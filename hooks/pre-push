#!/bin/bash
# dx-triage pre-push hook
# Part of the dx-triage enforcement system
#
# This hook runs before git push and checks:
# 1. Railway environment requirement (prime-radiant-ai, affordabot only)
# 2. dx-triage status flag (repo needs attention)
#
# Pass --no-verify to git push to bypass this hook.

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RESET='\033[0m'

# Get repo name from current directory
REPO_NAME="$(basename "$(git rev-parse --show-toplevel)")"

# NOTE: The Beads planning repo ("bd") is not part of dx-triage's canonical scan.
# Allow pushes so ~/bd can sync issues.jsonl across VMs without requiring DX_TRIAGE_STATUS files.
if [[ "$REPO_NAME" == "bd" ]]; then
    exit 0
fi

# Get current branch
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")"

# ============================================================================
# SECTION 0: Auto-checkpoint bypass
# ============================================================================
# Auto-checkpoint branches must bypass ALL safety checks to work.
# These are automated recovery branches, not human feature branches.
# If we block them, work never gets saved (defeats the purpose).

if [[ "$CURRENT_BRANCH" == wip/auto/* ]] || [[ "$CURRENT_BRANCH" == auto-checkpoint/* ]]; then
    # Allow auto-checkpoint pushes without any checks
    exit 0
fi

# ============================================================================
# SECTION 1: Railway environment check
# ============================================================================
# Blocks push if RAILWAY_ENVIRONMENT is NOT set (not in Railway project)
# Only applies to prime-radiant-ai and affordabot repos
# Requirement: RAILWAY_ENVIRONMENT must be non-empty to proceed

check_railway_status() {
    # Only enforce Railway for specific repos
    case "$REPO_NAME" in
        prime-radiant-ai|affordabot)
            # Check if we're in a Railway environment
            # RAILWAY_ENVIRONMENT is set when railway link/configure has been run
            if [[ -z "${RAILWAY_ENVIRONMENT:-}" ]]; then
                echo -e "${YELLOW}‚ö†Ô∏è  Railway environment not detected (Warning)${RESET}"
                echo ""
                echo "RAILWAY_ENVIRONMENT is not set."
                echo "This repo ($REPO_NAME) normally requires Railway to be configured."
                echo ""
                echo "To set up Railway (recommended):"
                echo "  railway login"
                echo "  railway link"
                echo ""
                # Warn only (was return 1)
                return 0
            fi
            ;;
        *)
            # Other repos don't require Railway
            ;;
    esac

    return 0
}

# ============================================================================
# SECTION 2: dx-triage status check
# ============================================================================


check_triage_status() {
    # Worktree-safe: store triage flags in the git *common* dir (shared across worktrees).
    # In a worktree, .git is a file, so .git/DX_TRIAGE_* is not valid.
    local common_dir
    common_dir="$(git rev-parse --git-common-dir 2>/dev/null || echo .git)"
    # Normalize to absolute path to avoid relative edge cases
    if [[ "$common_dir" != /* ]]; then
        common_dir="$(git rev-parse --show-toplevel)/$common_dir"
    fi
    common_dir="$(python3 -c 'import os,sys; print(os.path.abspath(sys.argv[1]))' "$common_dir")"

    local STATUS_FILE="$common_dir/DX_TRIAGE_STATUS"
    local REQUIRED_FILE="$common_dir/DX_TRIAGE_REQUIRED"
    local ACK_FILE="$common_dir/DX_TRIAGE_ACK"

    local block_reason=""
    local blocking_file=""

    # Check DX_TRIAGE_REQUIRED (critical - always blocks)
    if [[ -f "$REQUIRED_FILE" ]]; then
        block_reason="CRITICAL: Manual review required"
        blocking_file="$REQUIRED_FILE"
    fi

    # Check DX_TRIAGE_STATUS exists (required for forced review)
    if [[ ! -f "$STATUS_FILE" ]]; then
        if [[ -z "$block_reason" ]]; then
            block_reason="No status file found - run dx-triage-cron or dx-triage first"
            blocking_file="<missing>"
        fi
    fi

    # Check DX_TRIAGE_STATUS fingerprint vs ACK (forced review)
    # Compare fingerprint content, not file mtime, so timestamps can stay fresh
    if [[ -f "$STATUS_FILE" ]]; then
        current_fingerprint=$(grep "^X_FINGERPRINT:" "$STATUS_FILE" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        ack_fingerprint=$(grep "^X_FINGERPRINT:" "$ACK_FILE" 2>/dev/null | cut -d':' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

        # If fingerprints differ (or no ACK exists), review is required
        if [[ "$current_fingerprint" != "$ack_fingerprint" ]]; then
            if [[ -z "$block_reason" ]]; then
                block_reason="Status changed since last acknowledgment"
                blocking_file="$STATUS_FILE"
            fi
        fi
    fi

    # If no block needed, return success
    if [[ -z "$block_reason" ]]; then
        return 0
    fi

    # Display block message
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${RESET}"
    echo -e "${CYAN}‚ïë  ‚ö†Ô∏è  PUSH BLOCKED - $block_reason${RESET}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${RESET}"
    echo ""

    # Show the blocking file content (if file exists)
    if [[ -f "$blocking_file" ]]; then
        cat "$blocking_file"
        echo ""
    fi

    # Show ACK timestamp if exists
    if [[ -f "$ACK_FILE" ]]; then
        echo -e "${YELLOW}Last ACK:${RESET} $(stat -c %y "$ACK_FILE" 2>/dev/null | cut -d'.' -f1 || date -r "$ACK_FILE" '+%Y-%m-%d %H:%M:%S' 2>/dev/null)"
        echo ""
    fi

    echo -e "${YELLOW}Before pushing, you must:${RESET}"
    echo ""
    echo -e "  ${GREEN}dx-triage${RESET}              # See full status of all repos"
    echo -e "  ${GREEN}dx-triage --fix${RESET}         # Apply safe fixes"
    echo -e "  ${GREEN}dx-triage --ack${RESET}         # Acknowledge status and record review"
    echo ""
    echo -e "Or to bypass: ${CYAN}git push --no-verify${RESET}"
    echo ""

    return 1
}

# ============================================================================
# SECTION 3: ci-lite check (preserved from original hook)
# ============================================================================

check_ci_lite() {
    if [ -f Makefile ] && grep -q "ci-lite:" Makefile; then
        echo -e "${CYAN}üß™ Running make ci-lite...${RESET}"
        if ! make ci-lite; then
            echo -e "${RED}‚ùå PUSH BLOCKED: CI-Lite failed.${RESET}"
            echo -e "${YELLOW}üö® Fix errors before pushing or use --no-verify (not recommended).${RESET}"
            return 1
        fi
    fi
    return 0
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

# Run checks in order
check_railway_status || exit 1
check_triage_status || exit 1
check_ci_lite || exit 1

exit 0
